<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Express</title>
    <link rel="stylesheet" type="text/css" href="/css/object-describe.css" />
    <script type="application/javascript" src="/js/render.js"></script>
    <style type="text/css">
      body {
        padding: 0.5em 1em;
        font-family: 'Helvitica Neue', 'Helvetica', sans-serif;
        font-size: 12pt;
      }
      h2 {
        margin: 0;
      }
      textarea#input {
        box-sizing: border-box;
        width: 100%;
        height: 20em;
        font-family: monospace;
        font-size: 12pt;
        padding: 0.5em;
        line-height: 1.25;
      }
      #output.error {
        color: red;
      }
    </style>
  </head>

  <body>
    <h2>Input</h2>
    <form>
      <textarea spellcheck="false" id="input">
const asdf = { asdf: 'asdf' };
Sequence.from([asdf, asdf, asdf]);</textarea
      >
      <button id="doEval">Eval</button>
    </form>
    <h2>Output</h2>
    <div id="output"><!-- --></div>

    <script type="application/javascript">
      function cleanUp(js = '') {
        return js.replace(/\r/g, '/n');
      }

      document.body.addEventListener('click', evt => {
        if (evt.target && evt.target.matches('.toggleable')) {
          evt.target.classList.toggle('toggle-none');
        }
      });
      document.querySelector('#doEval').addEventListener('click', evt => {
        evt.preventDefault();
        doEval(document.querySelector('#input').value)
          .then(json => {
            // FIXME: How do you cancel a Promise chain?
            if (json) {
              document.querySelector('#output').classList.remove('error');
              document.querySelector('#output').innerHTML = render.renderHTML(
                json
              );
            }
          })
          .catch(err =>
            err.then(e => {
              document.querySelector('#output').innerHTML =
                e.body.errorResponse.message;
              document.querySelector('#output').classList.add('error');
            })
          );
      });
      function doEval(js) {
        return fetch('/eval', {
          method: 'POST',
          cache: 'no-cache',
          headers: { 'Content-Type': 'application/javascript' },
          body: js
        })
          .then(res => {
            if (res.status > 300) {
              throw res.json();
            }
            return res;
          })
          .then(res => res.json());
      }
    </script>
  </body>
</html>
